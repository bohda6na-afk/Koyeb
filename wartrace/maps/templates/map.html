<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>War Trace Vision</title>
  {% load static %}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <link rel="stylesheet" href="{% static 'css/map.css' %}" />
</head>
<body>
  <div id="map"></div>

  <!-- App Header -->
  <div class="app-header">
    <h1>War Trace Vision</h1>
    <div class="status">Live • Analyzing</div>
  </div>

  <!-- Menu Button -->
  <div class="menu-button">
    <svg viewBox="0 0 24 24">
      <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
  </div>

  <!-- Left Toolbar -->
  <div class="toolbar">
    <button id="marker-btn" title="Add Annotation">
      <svg viewBox="0 0 24 24">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
      </svg>
    </button>
    <button id="search-btn" title="Search Location">
      <svg viewBox="0 0 24 24">
        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
      </svg>
    </button>
    <div class="toolbar-divider"></div>
    <button id="draw-btn" title="Draw Area">
      <svg viewBox="0 0 24 24">
        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
      </svg>
    </button>
    <button id="ruler-btn" title="Measure">
      <svg viewBox="0 0 24 24">
        <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 10H3V8h2v4h2V8h2v4h2V8h2v4h2V8h2v4h2V8h2v8z"/>
      </svg>
    </button>
    <button id="ai-btn" title="AI Detection">
      <svg viewBox="0 0 24 24">
        <path d="M21 11c0-.55-.45-1-1-1h-1V7l-2-2H7L5 7v3H4c-.55 0-1 .45-1 1s.45 1 1 1h1v2c0 .55.45 1 1 1h1v2h2v-2h6v2h2v-2h1c.55 0 1-.45 1-1v-2h1c.55 0 1-.45 1-1zm-5 2H8v-2h8v2zm0-4H8V8h8v1z"/>
      </svg>
    </button>
    <button id="layers-btn" title="Map Layers">
      <svg viewBox="0 0 24 24">
        <path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"/>
      </svg>
    </button>
    <button id="legend-btn" title="Show Legend">
      <svg viewBox="0 0 24 24">
        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
      </svg>
    </button>
    <button id="zoom-in-btn" title="Zoom In">
      <svg viewBox="0 0 24 24">
        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
      </svg>
    </button>
    <button id="zoom-out-btn" title="Zoom Out">
      <svg viewBox="0 0 24 24">
        <path d="M19 13H5v-2h14v2z"/>
      </svg>
    </button>
  </div>

  <!-- Map Controls -->
  <div class="map-controls">
    <button id="satellite-btn" title="Satellite View">
      <svg viewBox="0 0 24 24">
        <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm-7 7H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4z"/>
      </svg>
    </button>
    <button id="dark-mode-btn" title="Toggle Dark Mode">
      <svg viewBox="0 0 24 24">
        <path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/>
      </svg>
    </button>
  </div>

  <!-- Map Legend -->
  <div class="map-legend">
    <h4>Damage Categories</h4>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #E57373;"></div>
      <div class="legend-text">Infrastructure Damage</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #7B1FA2;"></div>
      <div class="legend-text">Military Objects</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #FFA000;"></div>
      <div class="legend-text">Hazard Areas</div>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #388E3C;"></div>
      <div class="legend-text">Residential Damage</div>
    </div>
    <div class="toolbar-divider"></div>
    <h4>Verification Status</h4>
    <div class="legend-item">
      <div class="status-verified">Verified</div>
      <div class="legend-text">Community Verified</div>
    </div>
    <div class="legend-item">
      <div class="status-unverified">Unverified</div>
      <div class="legend-text">Awaiting Verification</div>
    </div>
    <div class="legend-item">
      <div class="status-ai-detected">AI Detected</div>
      <div class="legend-text">AI Analysis</div>
    </div>
  </div>

  <!-- AI Analysis Panel -->
  <div class="ai-analysis-panel">
    <div class="ai-analysis-header">
      <span>AI Detection Results</span>
      <button id="close-ai-panel">×</button>
    </div>
    <div class="ai-analysis-content">
      <div class="ai-analysis-item">
        <h4>Trench Detection <span class="ai-detection-score">97%</span></h4>
        <p>Multiple trenches detected in northern sector</p>
        <p>Length: ~320m, Width: 2-3m</p>
      </div>
      <div class="ai-analysis-item">
        <h4>Crater Analysis <span class="ai-detection-score">94%</span></h4>
        <p>Artillery impact pattern identified</p>
        <p>Approx. 12 craters, avg. diameter: 5m</p>
      </div>
      <div class="ai-analysis-item">
        <h4>Building Damage <span class="ai-detection-score">89%</span></h4>
        <p>Structural collapse detected in residential zone</p>
        <p>Damage classification: Severe (Level 4/5)</p>
      </div>
      <div class="ai-analysis-item">
        <h4>Vehicle Detection <span class="ai-detection-score">83%</span></h4>
        <p>Military vehicles identified near forest edge</p>
        <p>4 vehicles detected, classification in progress</p>
      </div>
      <div class="ai-analysis-item">
        <h4>Infrastructure Analysis <span class="ai-detection-score">92%</span></h4>
        <p>Bridge damage detected over river crossing</p>
        <p>Western span completely collapsed</p>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script>
    // Initialize map
    const map = L.map('map', {
      zoomControl: false  // Disable default zoom controls
    }).setView([48.3794, 38.2095], 11); // Eastern Ukraine coordinates
    
    // Set attributions with more relevant text for this project
    const attributionText = '© OpenStreetMap contributors | Imagery Analysis Platform for War Documentation';

    // Regular map layer - OpenStreetMap with custom attribution
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: attributionText,
      maxZoom: 19
    });

    // More detailed standard layer - OpenStreetMap Humanitarian style for better detail
    const detailedLayer = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
      attribution: attributionText,
      maxZoom: 19
    }).addTo(map);

    // Satellite layer with appropriate attribution
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: attributionText + ' | Satellite imagery from Esri',
      maxZoom: 19
    });
    
    // Labels layer for satellite mode
    const labelsLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
      attribution: attributionText,
      maxZoom: 19,
      pane: 'shadowPane'  // Place labels above the satellite imagery
    });

    // Add scale control
    L.control.scale({
      imperial: false,
      position: 'bottomleft'
    }).addTo(map);

    // Sample data for war-related destruction documentation
    const destructionData = [
      { 
        lat: 48.374, 
        lng: 38.198, 
        title: "Artillery Impact Zone", 
        description: "Multiple craters from artillery strikes",
        date: "2024-09-12", 
        confidence: "92%",
        category: "military",
        verification: "verified", 
        source: "Satellite imagery + community verification"
      },
      { 
        lat: 48.391, 
        lng: 38.209, 
        title: "Collapsed Bridge", 
        description: "Main bridge over river destroyed",
        date: "2024-09-15", 
        confidence: "97%",
        category: "infrastructure",
        verification: "verified",
        source: "Drone footage + structural analysis"
      },
      { 
        lat: 48.367, 
        lng: 38.236, 
        title: "Residential Building Damage", 
        description: "5-story apartment building partially collapsed",
        date: "2024-09-18", 
        confidence: "88%",
        category: "residential",
        verification: "unverified",
        source: "AI detection from satellite imagery"
      },
      { 
        lat: 48.389, 
        lng: 38.189, 
        title: "Unexploded Ordnance Area", 
        description: "Multiple UXO detected in field",
        date: "2024-09-20", 
        confidence: "85%",
        category: "hazard",
        verification: "ai-detected",
        source: "AI detection from aerial photography"
      },
      { 
        lat: 48.354, 
        lng: 38.214, 
        title: "School Building Damaged", 
        description: "Roof partially collapsed, structural damage to west wing",
        date: "2024-09-14", 
        confidence: "94%",
        category: "residential",
        verification: "verified",
        source: "On-site documentation + community report"
      },
      { 
        lat: 48.402, 
        lng: 38.225, 
        title: "Hospital Infrastructure", 
        description: "Damage to power supply and water facilities",
        date: "2024-09-22", 
        confidence: "91%",
        category: "infrastructure",
        verification: "unverified",
        source: "Remote sensing + thermal imaging"
      },
      { 
        lat: 48.382, 
        lng: 38.229, 
        title: "Trench System", 
        description: "Extensive military trenches extending 450m",
        date: "2024-09-17", 
        confidence: "96%",
        category: "military",
        verification: "verified",
        source: "High-resolution satellite imagery + AI analysis"
      },
      { 
        lat: 48.363, 
        lng: 38.198, 
        title: "Mine Field Risk Area", 
        description: "Suspected anti-personnel mine deployment",
        date: "2024-09-19", 
        confidence: "79%",
        category: "hazard",
        verification: "ai-detected",
        source: "Pattern recognition algorithm + terrain analysis"
      },
      { 
        lat: 48.393, 
        lng: 38.247, 
        title: "Agricultural Infrastructure", 
        description: "Grain storage facility destroyed",
        date: "2024-09-16", 
        confidence: "93%",
        category: "infrastructure",
        verification: "verified",
        source: "Drone footage + community verification"
      },
      { 
        lat: 48.378, 
        lng: 38.219, 
        title: "Power Station", 
        description: "Transformer substation heavily damaged",
        date: "2024-09-21", 
        confidence: "95%",
        category: "infrastructure",
        verification: "verified",
        source: "Technical assessment + thermal imagery"
      }
    ];

    function truncateText(text, maxLength) {
      if (text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    }

    function createMarker(item) {
      const markerClass = `marker-${item.category}`;
      
      const icon = L.divIcon({
        className: markerClass,
        iconSize: [12, 12]
      });
      
      const marker = L.marker([item.lat, item.lng], {
        icon: icon
      });
      
      const verificationStatus = item.verification === 'verified' ? 
        '<span class="status-verified">Verified</span>' : 
        (item.verification === 'ai-detected' ? 
          '<span class="status-ai-detected">AI Detected</span>' : 
          '<span class="status-unverified">Unverified</span>');
      
      // Truncate description to 60 characters
      const truncatedDescription = truncateText(item.description, 60);
      
      // Truncate source to 32 characters
      const truncatedSource = truncateText(item.source, 30);
      
      const tooltipContent = `
        <div class="tooltip">
          <h3>${item.title} ${verificationStatus}</h3>
          <p class="truncated-text" title="${item.description}">${truncatedDescription}</p>
          <p class="confidence">Confidence: ${item.confidence}</p>
          <p class="date" title="Date: ${item.date}">Date: ${item.date}</p>
          <p class="source" title="Source: ${item.source}">Source: ${truncatedSource}</p>
        </div>
      `;
      
      marker.bindTooltip(tooltipContent, {
        permanent: false,
        direction: 'top',
        offset: [0, -10],
        opacity: 1
      });
      
      return marker;
    }
    
    // Add all markers to map
    const markers = L.layerGroup();
    destructionData.forEach(item => {
      const marker = createMarker(item);
      marker.addTo(markers);
    });
    markers.addTo(map);
    
    // Variables to track UI state
    let isDarkMode = false;
    let isSatelliteMode = false;
    let isLegendVisible = false;
    let isAiPanelVisible = false;
    
    // Toggle dark mode
    document.getElementById('dark-mode-btn').addEventListener('click', function() {
      isDarkMode = !isDarkMode;
      document.body.classList.toggle('dark-mode', isDarkMode);
      
      // Update the dark mode button icon
      this.innerHTML = isDarkMode ? 
        '<svg viewBox="0 0 24 24"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"/></svg>' : 
        '<svg viewBox="0 0 24 24"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg>';
    });
    
    // Toggle satellite mode
    document.getElementById('satellite-btn').addEventListener('click', function() {
      isSatelliteMode = !isSatelliteMode;
      
      if (isSatelliteMode) {
        map.removeLayer(detailedLayer);
        map.removeLayer(osmLayer);
        satelliteLayer.addTo(map);
        labelsLayer.addTo(map);
      } else {
        map.removeLayer(satelliteLayer);
        map.removeLayer(labelsLayer);
        detailedLayer.addTo(map);
      }
      
      // Update button state
      this.classList.toggle('active', isSatelliteMode);
    });
    
    // Toggle legend visibility
    document.getElementById('legend-btn').addEventListener('click', function() {
      isLegendVisible = !isLegendVisible;
      document.querySelector('.map-legend').style.display = isLegendVisible ? 'block' : 'none';
    });
    
    // Zoom controls
    document.getElementById('zoom-in-btn').addEventListener('click', function() {
      map.zoomIn();
    });
    
    document.getElementById('zoom-out-btn').addEventListener('click', function() {
      map.zoomOut();
    });
    
    // Open AI analysis panel
    document.getElementById('ai-btn').addEventListener('click', function() {
      isAiPanelVisible = true;
      document.querySelector('.ai-analysis-panel').style.display = 'block';
    });
    
    // Close AI analysis panel
    document.getElementById('close-ai-panel').addEventListener('click', function() {
      isAiPanelVisible = false;
      document.querySelector('.ai-analysis-panel').style.display = 'none';
    });
    
    // Add user location marker when geolocation is allowed
    navigator.geolocation.getCurrentPosition(function(position) {
      const userIcon = L.divIcon({
        className: 'user-location',
        iconSize: [20, 20]
      });
      
      L.marker([position.coords.latitude, position.coords.longitude], {
        icon: userIcon
      }).addTo(map).bindTooltip("Your Location", {
        permanent: false,
        direction: 'top'
      });
    }, function() {
      // Geolocation error or denied
      console.log("Geolocation not available or denied");
    });
    
    // Simulate drawing mode
    document.getElementById('draw-btn').addEventListener('click', function() {
      alert("Drawing mode would allow users to outline damaged areas. This functionality requires additional libraries.");
    });
    
    // Simulate measurement tool
    document.getElementById('ruler-btn').addEventListener('click', function() {
      alert("Measurement tool would allow distance and area calculation. This functionality requires additional libraries.");
    });
    
    // Simulate search functionality
    document.getElementById('search-btn').addEventListener('click', function() {
      const location = prompt("Enter location to search:", "");
      if (location) {
        alert(`Search functionality would locate "${location}" on the map. This requires geocoding integration.`);
      }
    });
    
    // Simulate marker addition
    document.getElementById('marker-btn').addEventListener('click', function() {
      alert("This would open a form to add a new damage report at a selected location. Implementation requires form handling.");
    });
    
    // Simulate layer control
    document.getElementById('layers-btn').addEventListener('click', function() {
      alert("Layer control would allow toggling between different data layers like heat maps, damage density, etc.");
    });
    
    // Add a menu button functionality
    document.querySelector('.menu-button').addEventListener('click', function() {
      // This would normally open a full menu, but for simplicity we'll just toggle the toolbar
      document.querySelector('.toolbar').classList.toggle('expanded');
    });
    
    // Function to update the map with filters
    function updateMapFilters(filters) {
      // Remove existing markers
      map.removeLayer(markers);
      markers.clearLayers();
      
      // Apply filters
      const filteredData = destructionData.filter(item => {
        // Filter by category if specified
        if (filters.category && item.category !== filters.category) {
          return false;
        }
        
        // Filter by verification status if specified
        if (filters.verification && item.verification !== filters.verification) {
          return false;
        }
        
        // Filter by date range if specified
        if (filters.startDate && new Date(item.date) < new Date(filters.startDate)) {
          return false;
        }
        
        if (filters.endDate && new Date(item.date) > new Date(filters.endDate)) {
          return false;
        }
        
        return true;
      });
      
      // Add filtered markers
      filteredData.forEach(item => {
        const marker = createMarker(item);
        marker.addTo(markers);
      });
      
      // Add the filtered markers back to the map
      markers.addTo(map);
    }

    // Example of filtering (commented out, would be activated by UI controls)
    // updateMapFilters({ category: 'infrastructure', verification: 'verified' });
    
    // Initialize the map with all markers
    updateMapFilters({});
    
    // Simulate real-time updates with a simple timer
    setInterval(() => {
      const statusElement = document.querySelector('.app-header .status');
      statusElement.textContent = statusElement.textContent === 'Live • Analyzing' ? 
        'Live • Updated' : 'Live • Analyzing';
    }, 5000);
  </script>
</body>
</html>